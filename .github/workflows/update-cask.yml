name: update-cask

on:
  repository_dispatch:
    types:
      - update-vde-notifier-app-cask
  workflow_dispatch:
    inputs:
      version:
        description: "App version without app-v prefix (e.g. 0.1.1)"
        required: true
        type: string
      sha256:
        description: "SHA256 for VdeNotifierApp.app.tar.gz"
        required: true
        type: string

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve inputs
        id: payload
        run: |
          VERSION="${{ github.event.inputs.version || github.event.client_payload.version }}"
          SHA256="${{ github.event.inputs.sha256 || github.event.client_payload.sha256 }}"

          if [[ -z "${VERSION}" ]]; then
            echo "version is required" >&2
            exit 1
          fi

          if [[ ! "${SHA256}" =~ ^[0-9a-f]{64}$ ]]; then
            echo "sha256 must be a 64-character lowercase hex string" >&2
            exit 1
          fi

          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"
          echo "sha256=${SHA256}" >> "${GITHUB_OUTPUT}"

      - name: Update cask
        run: |
          VERSION="${{ steps.payload.outputs.version }}"
          SHA256="${{ steps.payload.outputs.sha256 }}"
          sed -E -i \
            -e "s/version \".*\"/version \"${VERSION}\"/" \
            -e "s/sha256 \"[0-9a-f]{64}\"/sha256 \"${SHA256}\"/" \
            Casks/vde-notifier-app.rb

      - name: Commit and push
        run: |
          if [[ -z "$(git diff --name-only Casks/vde-notifier-app.rb)" ]]; then
            echo "No cask changes detected."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Casks/vde-notifier-app.rb
          git commit -m "Update vde-notifier-app cask to ${{ steps.payload.outputs.version }}"
          git push
